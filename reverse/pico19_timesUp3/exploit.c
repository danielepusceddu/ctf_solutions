#include <stdio.h>
#include <signal.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <sys/wait.h>
#include <unistd.h>
#include "tinyexpr.h"

#define die(e) do { fprintf(stderr, "%s\n", e); exit(EXIT_FAILURE); } while (0);

int main() {
  int link[2];
  int parent2child[2];
  pid_t pid;

  signal(SIGALRM, SIG_IGN);

  if (pipe(link)==-1)
    die("pipe");

  if (pipe(parent2child) == -1)
      die("pipe2");

  if ((pid = fork()) == -1)
    die("fork");

  if(pid == 0) { //Child
    dup2 (link[1], STDOUT_FILENO);
    dup2(parent2child[0], STDIN_FILENO);

    close(link[0]);
    close(link[1]);
    close(parent2child[0]);
    close(parent2child[1]);
    usleep(10);
    execl("./times-up-one-last-time", "times-up-one-last-time", NULL);
    //execl("./notimer", "notimer", NULL);
    die("execl");

  } else {
    char line[1000];
    char flagStr[500];
    char* expression;
    char solutionStr[100] = "ciao";
    int numbytes;

    close(link[1]);
    close(parent2child[0]);

    int nbytes = read(link[0], line, sizeof(line));
    line[nbytes] = 0;

    expression = line + 11;
    for(int i = 0; i < nbytes - 11; i++){
        if(expression[i] == '\n'){
            expression[i] = '\0';
            break;
        }
    }

    //getting solution
    int err;
    long result = te_interp(expression, &err);
    int inputLen = sprintf(solutionStr, "%ld\n", result);

    //writing solution
    int written = write(parent2child[1], solutionStr, strlen(solutionStr)); 

    //reading response
    nbytes = read(link[0], flagStr, sizeof(flagStr));
    flagStr[nbytes] = 0;
    printf("Response: %s - %d - %d\n", flagStr, nbytes, written);  
    //wait(NULL);

  }
  return 0;
}
